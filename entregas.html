<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>√Årea de Entregas - Bombardi Control</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #121212;
      color: #f0f0f0;
      padding: 20px;
      min-height: 100vh;
    }
    h1, h2 { color: #ffffff; margin-bottom: 10px; }
    .container {
      background-color: #1e1e1e;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    input, select, textarea, button {
      padding: 10px; margin: 5px 0; width: 100%;
      border-radius: 5px; font-size: 16px;
      border: none;
    }
    input, select, textarea { background: #2c2c2c; color: #f0f0f0; resize: vertical; }
    button {
      background: #00ff88; color: #000;
      font-weight: bold; cursor: pointer;
    }
    button:hover {
      background: #00cc6a;
    }
    table {
      width: 100%; border-collapse: collapse; margin-top: 10px;
    }
    th, td {
      border: 1px solid #333; padding: 8px; text-align: left;
    }
    th {
      background-color: #333; color: #ffffff;
    }
    .btn-mini {
      width: 25px;
      height: 25px;
      margin-left: 5px;
      font-size: 14px;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      padding: 0;
      background: #ff4c4c;
      color: #fff;
      border-radius: 5px;
      cursor: pointer;
    }
    .btn-mini:hover {
      background: #b80000;
    }
    /* Modal */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-content {
      background: #1e1e1e;
      border-radius: 10px;
      padding: 20px;
      width: 320px;
      box-shadow: 0 0 10px #000;
    }
    .modal-content h3 {
      margin-bottom: 10px;
      color: #00ff88;
    }
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }
  </style>
</head>
<body>

<h1>üöö √Årea de Entregas</h1>
<button onclick="window.location.href='index.html'" style="margin-bottom: 20px; background: #00ff88;">üîô Voltar para Estoque</button>

<div class="container">
  <h2>Cadastrar Entrega</h2>
  <label for="materialSelect">Material:</label>
  <select id="materialSelect"></select>

  <label for="quantidadeInput">Quantidade:</label>
  <input type="number" id="quantidadeInput" min="1" placeholder="Quantidade retirada">

  <label for="destinoInput">Destino da entrega:</label>
  <input type="text" id="destinoInput" placeholder="Local da entrega">

  <label for="recebedorInput">Recebedor:</label>
  <input type="text" id="recebedorInput" placeholder="Nome do recebedor">

  <label for="obsInput">Observa√ß√µes:</label>
  <textarea id="obsInput" rows="3" placeholder="Observa√ß√µes"></textarea>

  <button onclick="cadastrarEntrega()">Salvar Entrega</button>
</div>

<div class="container">
  <h2>Relat√≥rio de Entregas</h2>
  <button onclick="gerarPDF()" style="background:#00cc6a; margin-bottom:10px;">üìÑ Gerar PDF</button>
  <table>
    <thead>
      <tr>
        <th>Material</th>
        <th>Quantidade</th>
        <th>Destino</th>
        <th>Recebedor</th>
        <th>Observa√ß√µes</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="tabelaEntregas"></tbody>
  </table>
</div>

<!-- Modal Edi√ß√£o -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3>Editar Entrega</h3>

    <label for="editMaterialSelect">Material:</label>
    <select id="editMaterialSelect"></select>

    <label for="editQuantidadeInput">Quantidade:</label>
    <input type="number" id="editQuantidadeInput" min="1">

    <label for="editDestinoInput">Destino:</label>
    <input type="text" id="editDestinoInput">

    <label for="editRecebedorInput">Recebedor:</label>
    <input type="text" id="editRecebedorInput">

    <label for="editObsInput">Observa√ß√µes:</label>
    <textarea id="editObsInput" rows="3"></textarea>

    <div class="modal-buttons">
      <button onclick="salvarEdicao()">Salvar</button>
      <button onclick="fecharModal()">Cancelar</button>
    </div>
  </div>
</div>

<script>
  let materiais = JSON.parse(localStorage.getItem('materiais') || '[]');
  let entregas = JSON.parse(localStorage.getItem('entregas') || '[]');

  let indexEdicao = null;

  // Preenche select de materiais (normal e modal)
  function preencherSelects() {
    const select = document.getElementById('materialSelect');
    const editSelect = document.getElementById('editMaterialSelect');
    select.innerHTML = '<option value="">Selecione um material</option>';
    editSelect.innerHTML = '<option value="">Selecione um material</option>';
    materiais.forEach((m, i) => {
      const option = `<option value="${i}">${m.nome} (${m.quantidade})</option>`;
      select.innerHTML += option;
      editSelect.innerHTML += option;
    });
  }

  function salvarMateriais() {
    localStorage.setItem('materiais', JSON.stringify(materiais));
  }

  function salvarEntregas() {
    localStorage.setItem('entregas', JSON.stringify(entregas));
  }

  // Cadastra entrega e atualiza estoque
  function cadastrarEntrega() {
    const materialIndex = document.getElementById('materialSelect').value;
    const qtd = parseInt(document.getElementById('quantidadeInput').value);
    const destino = document.getElementById('destinoInput').value.trim();
    const recebedor = document.getElementById('recebedorInput').value.trim();
    const obs = document.getElementById('obsInput').value.trim();

    if (materialIndex === '' || isNaN(qtd) || qtd <= 0 || !destino || !recebedor) {
      alert('Preencha todos os campos corretamente.');
      return;
    }

    const material = materiais[materialIndex];

    if (material.quantidade < qtd) {
      alert('Quantidade insuficiente no estoque!');
      return;
    }

    // Atualiza estoque
    material.quantidade -= qtd;
    salvarMateriais();

    // Adiciona entrega
    entregas.push({
      materialNome: material.nome,
      materialIndex,
      quantidade: qtd,
      destino,
      recebedor,
      obs,
      data: new Date().toLocaleString()
    });
    salvarEntregas();
    limparCampos();
    listarEntregas();
    preencherSelects();
  }

  // Limpa campos do formul√°rio
  function limparCampos() {
    document.getElementById('materialSelect').value = '';
    document.getElementById('quantidadeInput').value = '';
    document.getElementById('destinoInput').value = '';
    document.getElementById('recebedorInput').value = '';
    document.getElementById('obsInput').value = '';
  }

  // Lista entregas na tabela
  function listarEntregas() {
    const tbody = document.getElementById('tabelaEntregas');
    tbody.innerHTML = '';
    entregas.forEach((e, i) => {
      tbody.innerHTML += `<tr>
        <td>${e.materialNome}</td>
        <td>${e.quantidade}</td>
        <td>${e.destino}</td>
        <td>${e.recebedor}</td>
        <td>${e.obs}</td>
        <td>
          <button class="btn-mini" onclick="abrirModalEdicao(${i})">‚úèÔ∏è</button>
          <button class="btn-mini" onclick="excluirEntrega(${i})">‚úñ</button>
        </td>
      </tr>`;
    });
  }

  // Modal de edi√ß√£o
  function abrirModalEdicao(i) {
    indexEdicao = i;
    const e = entregas[i];

    // Preencher modal com dados atuais
    const editMaterialSelect = document.getElementById('editMaterialSelect');
    editMaterialSelect.value = materiais.findIndex(m => m.nome === e.materialNome);
    document.getElementById('editQuantidadeInput').value = e.quantidade;
    document.getElementById('editDestinoInput').value = e.destino;
    document.getElementById('editRecebedorInput').value = e.recebedor;
    document.getElementById('editObsInput').value = e.obs;

    document.getElementById('modal').style.display = 'flex';
  }

  // Fecha modal
  function fecharModal() {
    document.getElementById('modal').style.display = 'none';
  }

  // Salva edi√ß√£o e atualiza estoque
  function salvarEdicao() {
    const e = entregas[indexEdicao];

    const novoMaterialIndex = document.getElementById('editMaterialSelect').value;
    const novaQtd = parseInt(document.getElementById('editQuantidadeInput').value);
    const novoDestino = document.getElementById('editDestinoInput').value.trim();
    const novoRecebedor = document.getElementById('editRecebedorInput').value.trim();
    const novaObs = document.getElementById('editObsInput').value.trim();

    if (novoMaterialIndex === '' || isNaN(novaQtd) || novaQtd <= 0 || !novoDestino || !novoRecebedor) {
      alert('Preencha todos os campos corretamente.');
      return;
    }

    const materialAntigoIndex = materiais.findIndex(m => m.nome === e.materialNome);
    const materialAntigo = materiais[materialAntigoIndex];
    const materialNovo = materiais[novoMaterialIndex];

    // Ajustar estoque: devolver quantidade antiga e subtrair nova
    materialAntigo.quantidade += e.quantidade; // devolve a quantidade antiga para estoque

    if (materialNovo.quantidade < novaQtd) {
      alert('Quantidade insuficiente no estoque para a nova edi√ß√£o!');
      // re-subtrai a antiga para n√£o perder estoque
      materialAntigo.quantidade -= e.quantidade;
      return;
    }

    materialNovo.quantidade -= novaQtd;

    // Atualizar entrega
    entregas[indexEdicao] = {
      materialNome: materialNovo.nome,
      materialIndex: novoMaterialIndex,
      quantidade: novaQtd,
      destino: novoDestino,
      recebedor: novoRecebedor,
      obs: novaObs,
      data: e.data
    };

    salvarMateriais();
    salvarEntregas();
    fecharModal();
    listarEntregas();
    preencherSelects();
  }

  // Excluir entrega e devolver estoque
  function excluirEntrega(i) {
    if (!confirm('Deseja excluir esta entrega? A quantidade ser√° devolvida ao estoque.')) return;
    const e = entregas[i];
    const matIndex = materiais.findIndex(m => m.nome === e.materialNome);
    if (matIndex >= 0) {
      materiais[matIndex].quantidade += e.quantidade;
    }
    entregas.splice(i, 1);
    salvarMateriais();
    salvarEntregas();
    listarEntregas();
    preencherSelects();
  }

  // Gerar PDF com jspdf e autotable
  function gerarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(18);
    doc.setTextColor("#00ff88");
    doc.text("Relat√≥rio de Entregas", 14, 20);

    const linhas = entregas.map(e => [
      e.materialNome,
      e.quantidade.toString(),
      e.destino,
      e.recebedor,
      e.obs,
      e.data
    ]);

    doc.autoTable({
      head: [["Material", "Quantidade", "Destino", "Recebedor", "Observa√ß√µes", "Data"]],
      body: linhas,
      startY: 30,
      styles: { fillColor: [30, 30, 30], textColor: 240 },
      headStyles: { fillColor: [0, 255, 136], textColor: 0 },
      theme: 'grid'
    });

    doc.save("relatorio_entregas.pdf");
  }

  // Inicializa selects e lista na abertura
  preencherSelects();
  listarEntregas();

</script>
</body>
</html>
