<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Registro de Entregas</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      background: #121212;
      color: #f0f0f0;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
    }
    h1 {
      color: #00ff88;
    }
    .container {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 10px;
    }
    input, select, button {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
    }
    input, select {
      background: #2c2c2c;
      color: #fff;
    }
    button {
      background: #00ff88;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background: #00cc6e;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #333;
      padding: 10px;
    }
    th {
      background: #333;
      color: #00ff88;
    }
    .filter {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      background: #2c2c2c;
      color: #fff;
      border-radius: 5px;
      border: none;
    }
  </style>
</head>
<body>

<h1>Registro de Entregas</h1>
<div class="container">
  <select id="itemSelect"></select>
  <input type="number" id="qtdEntregue" placeholder="Quantidade Entregue">
  <input type="text" id="condominio" placeholder="Condomínio / Destino">
  <input type="text" id="recebedor" placeholder="Nome do Recebedor">
  <button onclick="registrarEntrega()">Registrar Entrega</button>
</div>

<h2>Histórico de Entregas</h2>
<input type="text" class="filter" id="filtroEntrega" placeholder="Filtrar por nome, condomínio, recebedor..." oninput="mostrarEntregas()">
<button onclick="gerarPDF()">Gerar PDF</button>

<table>
  <thead>
    <tr>
      <th>Data</th>
      <th>Item</th>
      <th>Qtd</th>
      <th>Condomínio</th>
      <th>Recebedor</th>
    </tr>
  </thead>
  <tbody id="historicoEntregas"></tbody>
</table>

<script>
  let materiais = JSON.parse(localStorage.getItem('materiais') || '[]');
  let entregas = JSON.parse(localStorage.getItem('entregas') || '[]');

  const itemSelect = document.getElementById('itemSelect');
  materiais.forEach((m, i) => {
    itemSelect.innerHTML += `<option value="${i}">${m.nome}</option>`;
  });

  function registrarEntrega() {
    const index = itemSelect.value;
    const qtd = parseInt(document.getElementById('qtdEntregue').value);
    const condominio = document.getElementById('condominio').value;
    const recebedor = document.getElementById('recebedor').value;
    if (!index || !qtd || !condominio || !recebedor) return alert("Preencha todos os campos!");
    const item = materiais[index];
    if (item.quantidade < qtd) return alert("Estoque insuficiente para essa entrega.");
    item.quantidade -= qtd;
    entregas.push({ data: new Date().toLocaleString(), nome: item.nome, quantidade: qtd, condominio, recebedor });
    localStorage.setItem('materiais', JSON.stringify(materiais));
    localStorage.setItem('entregas', JSON.stringify(entregas));
    mostrarEntregas();
  }

  function mostrarEntregas() {
    const filtro = document.getElementById('filtroEntrega').value?.toLowerCase() || '';
    const corpo = document.getElementById('historicoEntregas');
    corpo.innerHTML = '';
    entregas
      .filter(e =>
        e.nome.toLowerCase().includes(filtro) ||
        e.condominio.toLowerCase().includes(filtro) ||
        e.recebedor.toLowerCase().includes(filtro) ||
        e.data.toLowerCase().includes(filtro)
      )
      .forEach(e => {
        corpo.innerHTML += `<tr>
          <td>${e.data}</td>
          <td>${e.nome}</td>
          <td>${e.quantidade}</td>
          <td>${e.condominio}</td>
          <td>${e.recebedor}</td>
        </tr>`;
      });
  }

  function gerarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(18);
    doc.text("Relatório de Entregas", 14, 20);
    const linhas = entregas.map(e => [
      e.data, e.nome, e.quantidade, e.condominio, e.recebedor
    ]);
    doc.autoTable({
      head: [['Data', 'Item', 'Quantidade', 'Condomínio', 'Recebedor']],
      body: linhas,
      startY: 30
    });
    doc.save("entregas.pdf");
  }

  mostrarEntregas();
</script>

</body>
</html>
